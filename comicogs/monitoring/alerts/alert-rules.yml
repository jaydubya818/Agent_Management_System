# ==========================================
# COMICCOMP PRODUCTION ALERT RULES
# Comprehensive monitoring and alerting
# ==========================================

groups:
  # ==========================================
  # APPLICATION HEALTH ALERTS
  # ==========================================
  - name: application_health
    rules:
      - alert: ApplicationDown
        expr: up{job="comicogs-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "ComicComp API is down"
          description: "The ComicComp API has been down for more than 1 minute"

      - alert: FrontendDown
        expr: up{job="comicogs-frontend"} == 0
        for: 2m
        labels:
          severity: critical
          service: frontend
        annotations:
          summary: "ComicComp frontend is down"
          description: "The ComicComp frontend has been down for more than 2 minutes"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds_bucket{job="comicogs-api"}) > 2
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High API response time"
          description: "95th percentile response time is {{ $value }}s for more than 5 minutes"

      - alert: CriticalResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds_bucket{job="comicogs-api"}) > 5
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "Critical API response time"
          description: "95th percentile response time is {{ $value }}s for more than 2 minutes"

      - alert: HighErrorRate
        expr: rate(http_requests_total{job="comicogs-api",status=~"5.."}[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for more than 3 minutes"

      - alert: CriticalErrorRate
        expr: rate(http_requests_total{job="comicogs-api",status=~"5.."}[5m]) > 0.1
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for more than 1 minute"

  # ==========================================
  # DATABASE ALERTS
  # ==========================================
  - name: database_health
    rules:
      - alert: DatabaseDown
        expr: up{job="postgres-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL has been down for more than 1 minute"

      - alert: DatabaseConnectionsHigh
        expr: pg_stat_activity_count / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "High database connections"
          description: "Database connections are at {{ $value }}% of maximum for more than 5 minutes"

      - alert: DatabaseConnectionsCritical
        expr: pg_stat_activity_count / pg_settings_max_connections * 100 > 95
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Critical database connections"
          description: "Database connections are at {{ $value }}% of maximum for more than 1 minute"

      - alert: DatabaseSlowQueries
        expr: pg_stat_statements_mean_time_ms > 1000
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Slow database queries detected"
          description: "Average query time is {{ $value }}ms for more than 5 minutes"

      - alert: DatabaseDeadlocks
        expr: increase(pg_stat_database_deadlocks[5m]) > 0
        for: 0m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Database deadlocks detected"
          description: "{{ $value }} deadlocks detected in the last 5 minutes"

      - alert: DatabaseCacheHitRateLow
        expr: (pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read)) * 100 < 95
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Low database cache hit ratio"
          description: "Cache hit ratio is {{ $value }}% for more than 10 minutes"

  # ==========================================
  # REDIS CACHE ALERTS
  # ==========================================
  - name: redis_health
    rules:
      - alert: RedisDown
        expr: up{job="redis-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis has been down for more than 1 minute"

      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "High Redis memory usage"
          description: "Redis memory usage is at {{ $value }}% for more than 5 minutes"

      - alert: RedisMemoryCritical
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 95
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Critical Redis memory usage"
          description: "Redis memory usage is at {{ $value }}% for more than 1 minute"

      - alert: RedisConnectionsHigh
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "High Redis connections"
          description: "Redis has {{ $value }} connected clients for more than 5 minutes"

      - alert: RedisSlowlog
        expr: increase(redis_slowlog_length[5m]) > 0
        for: 0m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis slow queries detected"
          description: "{{ $value }} slow queries detected in the last 5 minutes"

  # ==========================================
  # SYSTEM RESOURCE ALERTS
  # ==========================================
  - name: system_resources
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }} for more than 5 minutes"

      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Critical CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }} for more than 2 minutes"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }} for more than 5 minutes"

      - alert: CriticalMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Critical memory usage"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }} for more than 2 minutes"

      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Low disk space"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }} {{ $labels.mountpoint }} for more than 5 minutes"

      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 95
        for: 1m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Critical disk space"
          description: "Disk usage is {{ $value }}% on {{ $labels.instance }} {{ $labels.mountpoint }} for more than 1 minute"

      - alert: HighIOWait
        expr: rate(node_cpu_seconds_total{mode="iowait"}[5m]) * 100 > 20
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High I/O wait"
          description: "I/O wait is {{ $value }}% on {{ $labels.instance }} for more than 5 minutes"

  # ==========================================
  # APPLICATION-SPECIFIC ALERTS
  # ==========================================
  - name: comiccomp_business
    rules:
      - alert: HighUserRegistrations
        expr: increase(user_registrations_total[1h]) > 100
        for: 0m
        labels:
          severity: info
          service: business
        annotations:
          summary: "High user registration rate"
          description: "{{ $value }} new user registrations in the last hour"

      - alert: MarketplaceListingSpike
        expr: increase(marketplace_listings_created_total[1h]) > 500
        for: 0m
        labels:
          severity: info
          service: business
        annotations:
          summary: "High marketplace listing activity"
          description: "{{ $value }} new marketplace listings created in the last hour"

      - alert: PaymentFailures
        expr: increase(payment_failures_total[5m]) > 5
        for: 0m
        labels:
          severity: warning
          service: payments
        annotations:
          summary: "Payment failures detected"
          description: "{{ $value }} payment failures in the last 5 minutes"

      - alert: SearchPerformanceDegraded
        expr: histogram_quantile(0.95, search_request_duration_seconds_bucket) > 3
        for: 5m
        labels:
          severity: warning
          service: search
        annotations:
          summary: "Search performance degraded"
          description: "95th percentile search time is {{ $value }}s for more than 5 minutes"

      - alert: CacheHitRateLow
        expr: cache_hits_total / (cache_hits_total + cache_misses_total) * 100 < 80
        for: 10m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Low cache hit ratio"
          description: "Cache hit ratio is {{ $value }}% for more than 10 minutes"

  # ==========================================
  # SECURITY ALERTS
  # ==========================================
  - name: security
    rules:
      - alert: HighFailedLogins
        expr: increase(failed_login_attempts_total[5m]) > 20
        for: 0m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "High failed login attempts"
          description: "{{ $value }} failed login attempts in the last 5 minutes"

      - alert: SuspiciousActivity
        expr: increase(suspicious_requests_total[5m]) > 10
        for: 0m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Suspicious activity detected"
          description: "{{ $value }} suspicious requests in the last 5 minutes"

      - alert: RateLimitTriggered
        expr: increase(rate_limit_exceeded_total[1m]) > 50
        for: 0m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Rate limiting triggered"
          description: "{{ $value }} rate limit violations in the last minute"

      - alert: SQLInjectionAttempt
        expr: increase(sql_injection_attempts_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: security
        annotations:
          summary: "SQL injection attempt detected"
          description: "{{ $value }} SQL injection attempts in the last 5 minutes"

  # ==========================================
  # SSL CERTIFICATE ALERTS
  # ==========================================
  - name: ssl_certificates
    rules:
      - alert: SSLCertificateExpiringSoon
        expr: ssl_certificate_expiry_days < 30
        for: 0m
        labels:
          severity: warning
          service: ssl
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate for {{ $labels.domain }} expires in {{ $value }} days"

      - alert: SSLCertificateExpiring
        expr: ssl_certificate_expiry_days < 7
        for: 0m
        labels:
          severity: critical
          service: ssl
        annotations:
          summary: "SSL certificate expiring very soon"
          description: "SSL certificate for {{ $labels.domain }} expires in {{ $value }} days"

  # ==========================================
  # BUSINESS METRICS ALERTS
  # ==========================================
  - name: business_metrics
    rules:
      - alert: RevenueAnomaly
        expr: abs(revenue_current_hour - revenue_previous_hour) / revenue_previous_hour > 0.5
        for: 0m
        labels:
          severity: info
          service: business
        annotations:
          summary: "Revenue anomaly detected"
          description: "Revenue changed by {{ $value | humanizePercentage }} compared to previous hour"

      - alert: UserEngagementLow
        expr: active_users_1h < 10
        for: 30m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Low user engagement"
          description: "Only {{ $value }} active users in the last hour for more than 30 minutes"

      - alert: ConversionRateLow
        expr: marketplace_conversion_rate_1h < 0.02
        for: 1h
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Low marketplace conversion rate"
          description: "Marketplace conversion rate is {{ $value | humanizePercentage }} for more than 1 hour"

  # ==========================================
  # EXTERNAL SERVICES ALERTS
  # ==========================================
  - name: external_services
    rules:
      - alert: StripeAPIDown
        expr: stripe_api_success_rate < 0.95
        for: 5m
        labels:
          severity: critical
          service: payments
        annotations:
          summary: "Stripe API issues"
          description: "Stripe API success rate is {{ $value | humanizePercentage }} for more than 5 minutes"

      - alert: EmailServiceDown
        expr: email_delivery_success_rate < 0.9
        for: 10m
        labels:
          severity: warning
          service: email
        annotations:
          summary: "Email delivery issues"
          description: "Email delivery success rate is {{ $value | humanizePercentage }} for more than 10 minutes"

      - alert: ComicAPIDown
        expr: comic_api_success_rate < 0.8
        for: 15m
        labels:
          severity: warning
          service: external_api
        annotations:
          summary: "Comic database API issues"
          description: "Comic API success rate is {{ $value | humanizePercentage }} for more than 15 minutes"